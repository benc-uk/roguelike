import a from"https://cdn.jsdelivr.net/npm/alpinejs@3.14.0/dist/module.esm.min.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class f{constructor(t,e=16){this.name=t||`Sprite ${Math.random().toString(36).substring(7)}`,this.data=[],this.size=e;for(let o=0;o<e;o++){this.data[o]=[];for(let i=0;i<e;i++)this.data[o][i]=null}}toImageSrc(t=[]){const e=document.createElement("canvas");e.width=this.size,e.height=this.size;const o=e.getContext("2d");for(let i=0;i<this.size;i++)for(let r=0;r<this.size;r++){const l=t[this.data[i][r]];l&&(o.fillStyle=l,o.fillRect(r,i,1,1))}return e.toDataURL()}loadData(t){if(t.length!==this.size)throw new Error("Data is not the correct size");this.data=t}drawOnCanvas(t,e,o,i=[]){for(let r=0;r<this.size;r++)for(let l=0;l<this.size;l++){const c=i[this.data[r][l]];c&&(t.fillStyle=c,t.fillRect(e+l,o+r,1,1))}}}function S(){const s="0123456789ABCDEF";let t="#";for(let e=0;e<6;e++)t+=s[Math.floor(Math.random()*16)];return t}const $=()=>({size:16,projectLoaded:!1,newSpriteSize:12,newPaletteSize:16,newBankSize:128,copySprite:null,init(){console.log("App initializing");try{this.loadFromStorage()}catch(s){console.error("Error loading project",s)}},async loadFromStorage(){console.log("Loading project from browser storage");const s=await localStorage.getItem("project");if(s){console.log("Loading stored project");try{const t=await JSON.parse(s),e=[];for(const i of t.sprites){const r=new f(i.name,i.size);r.loadData(i.data),e.push(r)}const o=[];for(const i of t.palette)o.push(i);this.$store.pal.colours=o,this.$store.sprites.sprites=e,this.size=t.size,this.$store.sprites.select(t.selected),this.$store.map=t.map,this.projectLoaded=!0}catch(t){console.error("Error loading & parsing project",t)}}},saveToStorage(){localStorage.setItem("project",JSON.stringify({size:this.size,sprites:this.$store.sprites.sprites,palette:this.$store.pal.colours,selected:this.$store.sprites.selectedIndex(),map:this.$store.map}))},newProject(){console.log("Creating new project");try{const s=[];for(let e=0;e<this.newBankSize;e++){const o=`Sprite ${e}`;s.push(new f(o,this.newSpriteSize))}this.$store.sprites.sprites=s;const t=[];for(let e=0;e<this.newPaletteSize;e++)t.push(S());this.$store.pal.colours=t,this.size=this.newSpriteSize,this.saveToStorage(),this.projectLoaded=!0,console.log("New project created and stored")}catch(s){console.error("Error creating new project",s)}},eraseProject(){prompt('Are you sure you want to erase the project? Enter "yes" to confirm')==="yes"&&(console.log("Erasing & resetting project"),localStorage.removeItem("project"),this.projectLoaded=!1)},exportProject(){console.log("Exporting project to file");const s=localStorage.getItem("project"),t=new Blob([s],{type:"application/json"}),e=URL.createObjectURL(t),o=document.createElement("a");o.href=e,o.download="project.json",o.click()},importProject(){console.log("Importing project from file");const s=document.createElement("input");s.type="file",s.accept="application/json",s.onchange=async t=>{const e=t.target.files[0],o=new FileReader;o.onload=async i=>{const r=i.target.result;localStorage.setItem("project",r),this.loadFromStorage(),location.reload()},o.readAsText(e)},s.click()},exportAllSprites(){console.log("Exporting sprite sheet");const s=document.createElement("canvas"),t=this.$store.sprites.sprites.length,e=8,o=Math.ceil(t/e);s.width=this.size*e,s.height=this.size*o,console.log("Exporting sprites",t,"in",e,"x",o,"grid");const i={size:this.size,count:t,sprites:[]},r=s.getContext("2d");let l=0;for(let p=0;p<o;p++)for(let n=0;n<e;n++)if(l<t){const d=this.$store.sprites.sprites[l];d.drawOnCanvas(r,n*this.size,p*this.size,this.$store.pal.colours),i.sprites.push({name:d.name,x:n*this.size,y:p*this.size}),l++}const c=document.createElement("a");c.href=s.toDataURL(),c.download="sprites.png",c.click();const g=new Blob([JSON.stringify(i)],{type:"application/json"}),h=document.createElement("a");h.href=URL.createObjectURL(g),h.download="sprites.json",h.click()},toolCopy(){this.$store.sprites.selected()&&(this.copySprite=this.$store.sprites.selected(),console.log("Copied sprite",this.copySprite))},toolPaste(){if(this.copySprite){const s=[];for(let t=0;t<this.copySprite.size;t++){s[t]=[];for(let e=0;e<this.copySprite.size;e++)s[t][e]=this.copySprite.data[t][e]}this.$store.sprites.selected().loadData(s),this.$store.sprites.selected().name=this.copySprite.name,console.log("Pasted sprite",this.copySprite)}}}),A=s=>({cellSize:0,ctx:null,sprite:null,pallet:null,init(){console.log("Editor init");const t=this.$refs.canvas;this.ctx=this.$refs.canvas.getContext("2d"),this.cellSize=t.width/s,this.sprite=this.$store.sprites.selected(),this.pallet=this.$store.pal,this.drawSprite(),this.drawGrid()},drawGrid(){this.ctx.strokeStyle="#222",this.ctx.lineWidth=2;for(let t=0;t<=s;t++)this.ctx.beginPath(),this.ctx.moveTo(t*this.cellSize,0),this.ctx.lineTo(t*this.cellSize,this.$refs.canvas.height),this.ctx.stroke();for(let t=0;t<=s;t++)this.ctx.beginPath(),this.ctx.moveTo(0,t*this.cellSize),this.ctx.lineTo(this.$refs.canvas.width,t*this.cellSize),this.ctx.stroke()},drawSprite(){this.sprite=this.$store.sprites.selected(),this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.$refs.canvas.width,this.$refs.canvas.height);for(let t=0;t<s;t++)for(let e=0;e<s;e++)this.sprite.data[t][e]!==null&&(this.ctx.fillStyle=this.$store.pal.colours[this.sprite.data[t][e]],this.ctx.fillRect(e*this.cellSize,t*this.cellSize,this.cellSize,this.cellSize))},handleClick(t){const e=Math.floor(t.offsetX/this.cellSize),o=Math.floor(t.offsetY/this.cellSize);t.buttons===1?this.fillCell(e,o):t.buttons===2&&this.clearCell(e,o),t.type==="click"&&this.fillCell(e,o),t.type==="contextmenu"&&this.clearCell(e,o)},fillCell(t,e){this.ctx.fillStyle=this.$store.pal.colour(),this.ctx.fillRect(t*this.cellSize,e*this.cellSize,this.cellSize,this.cellSize),this.$store.sprites.selected().data[e][t]=this.$store.pal.selected(),this.drawGrid()},clearCell(t,e){this.ctx.clearRect(t*this.cellSize,e*this.cellSize,this.cellSize,this.cellSize),this.$store.sprites.selected().data[e][t]=null,this.drawGrid()},colourChange(t){this.colour=t.target.value},toolClear(){this.sprite.data=this.sprite.data.map(()=>Array(s).fill(null))},toolFlipX(){this.sprite.data=this.sprite.data.map(t=>t.reverse())},toolFlipY(){this.sprite.data=this.sprite.data.reverse()},toolColour(){this.sprite.data=this.sprite.data.map(t=>t.map(e=>e===null?null:this.$store.pal.selected()))},toolMoveDown(){this.sprite.data.unshift(this.sprite.data.pop())},toolMoveUp(){this.sprite.data.push(this.sprite.data.shift())},toolMoveRight(){this.sprite.data=this.sprite.data.map(t=>(t.unshift(t.pop()),t))},toolMoveLeft(){this.sprite.data=this.sprite.data.map(t=>(t.push(t.shift()),t))}}),m=()=>({editColour(s,t){this.$store.pal.colours[t]=s.target.value,this.$store.pal.select(t),this.$dispatch("palette",{})},selectColour(s,t){s.preventDefault(),this.$store.pal.select(t)}}),y=()=>({spriteImages:[],activeSprite:null,init(){console.log("Bank init"),this.activeSprite=this.$store.sprites.selected();for(const s of this.$store.sprites.sprites)this.spriteImages.push(s.toImageSrc(this.$store.pal.colours));window.addEventListener("palette",this.paletteUpdated.bind(this))},paletteUpdated(){let s=0;for(const t of this.$store.sprites.sprites)this.spriteImages[s]=t.toImageSrc(this.$store.pal.colours),s++},updateSprite(){this.spriteImages[this.$store.sprites.selectedIndex()]=this.$store.sprites.selected().toImageSrc(this.$store.pal.colours)}}),u="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAAXNSR0IArs4c6QAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAABNJREFUCB1jZGBg+A/EDEwgAgQADigBA//q6GsAAAAASUVORK5CYII%3D",x=()=>({map:[],mapData:[],width:12,height:6,init(){console.log("Scratch init"),this.$refs.scratchGrid.style.gridTemplateColumns=`repeat(${this.width}, fit-content(100%))`;let s=this.width*this.height;this.mapData=this.$store.map,this.map=[];for(let t=0;t<s;t++){let e=u;this.mapData[t]!==-1&&(e=this.$store.sprites.get(this.mapData[t]).toImageSrc(this.$store.pal.colours)),this.map.push({index:this.mapData[t]||-1,image:e})}},updateSprite(){const s=this.$store.sprites.selectedIndex(),t=this.$store.sprites.get(s).toImageSrc(this.$store.pal.colours);for(let e=0;e<this.map.length;e++)this.map[e].index===s&&(this.map[e].image=t)},clickCell(s,t){if(s.type==="contextmenu"){this.clearCell(t);return}this.map[t].index=this.$store.sprites.selectedIndex(),this.map[t].image=this.$store.sprites.selected().toImageSrc(this.$store.pal.colours)},clearCell(s){this.map[s].index=-1,this.map[s].image=u},updateStore(){const s=this.map.map(t=>t.index);this.$store.map=s}});a.store("pal",{colours:[],_selected:0,selected(){return this._selected},colour(){return this.colours[this._selected]},select(s){this._selected=s}});a.store("sprites",{sprites:[],_selected:0,selected(){return this.sprites[this._selected]},selectedIndex(){return this._selected},select(s){this._selected=s},get(s){return this.sprites[s]}});a.store("scratch",[]);a.data("app",$);a.data("palette",m);a.data("bank",y);a.data("palette",m);a.data("editor",A);a.data("map",x);a.start();
